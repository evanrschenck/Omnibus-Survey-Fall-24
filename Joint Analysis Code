load_or_install <- function(package) {
  if (!require(package, character.only = TRUE)) {
    install.packages(package)
    library(package, character.only = TRUE)
  }
}

load_or_install("dplyr")
load_or_install("ggplot2")
load_or_install("visdat")
load_or_install("naniar")
load_or_install("margins")
library(dplyr)
load_or_install("broom")
library(broom)

# Clean data: Select specific columns
data_cleaned_attendance <- `Omnibus_Survey_Analysis` %>%
  select(Q17, Q23, Q14, Q62...27, Q31, Q33, Q37, Q92...182, Q93...183, Q94, Q98, Q99, Q100)

# Rename columns for better readability
renameddata_attendance <- data_cleaned_attendance %>%
  rename(
    Political_Party_noncoded = Q17,
    Liberal_Conservative_noncoded = Q23,
    Election_Choice_noncoded = Q14,
    Political_Engagement_noncoded = Q62...27,
    National_Trust_noncoded = Q92...182,
    LocalGov_trust_noncoded = Q93...183,
    Trust_Others_noncoded = Q94,
    Control = Q98,
    Treatment_Consequence = Q99,
    Treatment_Norms = Q100,
    Gender_noncoded = Q31,
    Racial_Identity_noncoded = Q33,
    Religious_Attendance_noncoded = Q37
  )
  
# Apply all filters in one step
filtered_data_attendance <- renameddata_attendance %>%
  filter(
    Gender_noncoded %in% c("Female", "Male", "Prefer not to disclose.", "None of the above. I identify myself as"),
    Political_Party_noncoded %in% c("Republican", "Democrat", "Independent", "Other", "Don't know"),
    Racial_Identity_noncoded %in% c("White", "Hispanic", "Black", "Multi-racial", "Native American", "Asian", "Other"),
    Liberal_Conservative_noncoded %in% c("Extremely Liberal", "Liberal", "Slightly Liberal", "Moderate/ Middle of the Road", "Slightly Conservative", "Conservative", "Extremely Conservative"),
    Religious_Attendance_noncoded %in% c("Never", "Once a year or less", "A few times a year", "Once or twice a month", "Once a week", "More than once a week")
  )
  
survey_data_attendance <- filtered_data_attendance %>%
  mutate(Gender = ifelse(Gender_noncoded == "Male", 1, 
                               ifelse(Gender_noncoded == "Female", 2, NA)))
                    
survey_data_attendance <- survey_data_attendance %>%
  mutate(Religious_Attendance = ifelse(Religious_Attendance_noncoded== "Never", 1,
                                            ifelse(Religious_Attendance_noncoded== "Once a year or less", 2,
                                                   ifelse(Religious_Attendance_noncoded== "A Few times a year", 3,
                                                          ifelse(Religious_Attendance_noncoded== "Once or twice a month", 4,
                                                                 ifelse(Religious_Attendance_noncoded== "Once a week", 5,
                                                                        ifelse(Religious_Attendance_noncoded== "More than once a week", 6, NA))))) ))
                                                                        
survey_data_attendance <- survey_data_attendance %>%
  mutate(Political_Party = ifelse(Political_Party_noncoded== "Democrat", 1,
                                        ifelse(Political_Party_noncoded== "Independent", 2,
                                               ifelse(Political_Party_noncoded== "Other", 2,
                                                      ifelse(Political_Party_noncoded== "Don't Know", 2,
                                                             ifelse(Political_Party_noncoded== "Republican", 3, NA))))))
                                                          
survey_data_attendance <- survey_data_attendance %>%
  mutate(National_Trust = ifelse(National_Trust_noncoded== "Almost never", 1,
                                       ifelse(National_Trust_noncoded== "Only some of the time", 2,
                                              ifelse(National_Trust_noncoded== "Most of the time", 3,
                                                     ifelse(National_Trust_noncoded== "Just about always", 4, NA)))))
                                                     
survey_data_attendance <- survey_data_attendance %>%
  mutate(LocalGov_Trust = ifelse(LocalGov_trust_noncoded== "Almost never", 1,
                                       ifelse(LocalGov_trust_noncoded== "Only some of the time", 2,
                                              ifelse(LocalGov_trust_noncoded== "Most of the time", 3,
                                                     ifelse(LocalGov_trust_noncoded== "Just about always", 4, NA)))))
                                                     
survey_data_attendance <- survey_data_attendance %>%
  mutate(Trust_Others = ifelse(Trust_Others_noncoded== "1- You can't be too careful", 1,
                                       ifelse(Trust_Others_noncoded== "2", 2,
                                              ifelse(Trust_Others_noncoded== "3", 3,
                                                     ifelse(Trust_Others_noncoded== "4", 4,
                                                            ifelse(Trust_Others_noncoded== "5- Most people can be trusted", 5, NA))))))
                                                            
survey_data_attendance <- survey_data_attendance %>%
  mutate(Trust_Others_HighLow = ifelse(Trust_Others_noncoded== "1- You can't be too careful", 0,
                                       ifelse(Trust_Others_noncoded== "2", 0,
                                              ifelse(Trust_Others_noncoded== "3", 0,
                                                     ifelse(Trust_Others_noncoded== "4", 1,
                                                            ifelse(Trust_Others_noncoded== "5- Most people can be trusted", 1, NA))))))
                                                            
survey_data_attendance <- survey_data_attendance %>%
  mutate(LocalGov_Trust_HighLow = ifelse(LocalGov_trust_noncoded== "Almost never", 0,
                                       ifelse(LocalGov_trust_noncoded== "Only some of the time", 0,
                                              ifelse(LocalGov_trust_noncoded== "Most of the time", 1,
                                                     ifelse(LocalGov_trust_noncoded== "Just about always", 1, NA)))))
                                                     
survey_data_attendance <- survey_data_attendance %>%
  mutate(National_Trust_HighLow = ifelse(National_Trust_noncoded== "Almost never", 0,
                                       ifelse(National_Trust_noncoded== "Only some of the time", 0,
                                              ifelse(National_Trust_noncoded== "Most of the time", 1,
                                                     ifelse(National_Trust_noncoded== "Just about always", 1, NA)))))
survey_data_attendance <- survey_data_attendance %>%
  mutate(Religious_HighLow = ifelse(Religious_Attendance_noncoded== "Never", 0,
                                            ifelse(Religious_Attendance_noncoded== "Once a year or less", 0,
                                                   ifelse(Religious_Attendance_noncoded== "A Few times a year", 0,
                                                          ifelse(Religious_Attendance_noncoded== "Once or twice a month", 0,
                                                                 ifelse(Religious_Attendance_noncoded== "Once a week", 1,
                                                                        ifelse(Religious_Attendance_noncoded== "More than once a week", 1, NA))))) ))
                                                            
survey_data_attendance_control <- survey_data_attendance %>%
  filter(Control %in% c("Leave the treaty", "Remain in the treaty")) %>%
  mutate(exit_treaty = ifelse(Control == "Leave the treaty", 1, 0))
  
table(survey_data_attendance$Control, useNA = "always")
table(survey_data_attendance_control$exit_treaty, useNA = "always")

model_attendance_control <- glm(exit_treaty ~ Gender + Political_Party + Religious_Attendance + National_Trust + LocalGov_Trust + Trust_Others, 
             data = survey_data_attendance_control, family = binomial(link = "logit"))

summary(model_attendance_control)

library(margins)
marginal_effects_attendance_control <- margins(model_attendance_control)
summary(marginal_effects_attendance_control)


survey_data_attendance_norms <- survey_data_attendance %>%
  filter(Treatment_Norms %in% c("Leave the treaty", "Remain in the treaty")) %>%
  mutate(exit_treaty = ifelse(Treatment_Norms == "Leave the treaty", 1, 0))
  

model_attendance_norms <- glm(exit_treaty ~ Gender + Political_Party + Religious_Attendance + National_Trust + LocalGov_Trust + Trust_Others, 
             data = survey_data_attendance_norms, family = binomial(link = "logit"))

summary(model_attendance_norms)

library(margins)
marginal_effects_attendance_norms <- margins(model_attendance_norms)
summary(marginal_effects_attendance_norms)
                               
survey_data_attendance_consequence <- survey_data_attendance %>%
  filter(Treatment_Consequence %in% c("Leave the treaty", "Remain in the treaty")) %>%
  mutate(exit_treaty = ifelse(Treatment_Consequence == "Leave the treaty", 1, 0))
  

model_attendance_consequence <- glm(exit_treaty ~ Gender + Political_Party + Religious_Attendance + National_Trust + LocalGov_Trust + Trust_Others, 
             data = survey_data_attendance_consequence, family = binomial(link = "logit"))

summary(model_attendance_consequence)

library(margins)
marginal_effects_attendance_consequence <- margins(model_attendance_consequence)
summary(marginal_effects_attendance_consequence)

# FOR RELIGIOUS AFFILIATION

data_cleaned_affiliation <- `Omnibus_Survey_Analysis` %>% select(Q17, Q23, Q14, Q62...27, Q31, Q33, Q92...182, Q93...183, Q94, Q98, Q99, Q100, Q131)


renameddata_affiliation <- data_cleaned_affiliation %>%
     rename(
         Political_Party_noncoded = Q17,
         Liberal_Conservative_noncoded = Q23,
         Election_Choice_noncoded = Q14,
         Political_Engagement_noncoded = Q62...27,
         National_Trust_noncoded = Q92...182,
         LocalGov_trust_noncoded = Q93...183,
         Trust_Others_noncoded = Q94,
         Control = Q98,
         Treatment_Consequence = Q99,
         Treatment_Norms = Q100,
         Gender_noncoded = Q31,
         Racial_Identity_noncoded = Q33,
         Religious_Affiliation_noncoded  = Q131)


filtered_data_affiliation <- renameddata_affiliation %>%
     filter(
         Gender_noncoded %in% c("Female", "Male", "Prefer not to disclose.", "None of the above. I identify myself as"),
         Political_Party_noncoded %in% c("Republican", "Democrat", "Independent", "Other", "Don't know"),
         Racial_Identity_noncoded %in% c("White", "Hispanic", "Black", "Multi-racial", "Native American", "Asian", "Other"),
         Liberal_Conservative_noncoded %in% c("Extremely Liberal", "Liberal", "Slightly Liberal", "Moderate/ Middle of the Road", "Slightly Conservative", "Conservative", "Extremely Conservative"),
         Religious_Affiliation_noncoded %in% c("None", "Catholic", "Protestant", "Other", "Jewish", "Muslim"))


survey_data_affiliation <- filtered_data_affiliation %>%
     mutate(Gender = ifelse(Gender_noncoded == "Male", 1, 
                                  ifelse(Gender_noncoded == "Female", 2, NA)))


survey_data_affiliation <- survey_data_affiliation %>%
     mutate(Religious_Affiliation = ifelse(Religious_Affiliation_noncoded== "None", 0,
                                                ifelse(Religious_Affiliation_noncoded== "Catholic", 1,
                                                       ifelse(Religious_Affiliation_noncoded== "Protestant", 1,
                                                              ifelse(Religious_Affiliation_noncoded== "Jewish", 1,
                                                                     ifelse(Religious_Affiliation_noncoded== "Muslim", 1,                                                                            ifelse(Religious_Affiliation_noncoded== "Other", 1, NA))))) ))
                            

survey_data_affiliation <- survey_data_affiliation %>%
     mutate(Political_Party = ifelse(Political_Party_noncoded== "Democrat", 1,
                                           ifelse(Political_Party_noncoded== "Independent", 2,
                                                  ifelse(Political_Party_noncoded== "Other", 2,
                                                         ifelse(Political_Party_noncoded== "Don't Know", 2,
                                                                ifelse(Political_Party_noncoded== "Republican", 3, NA))))))


survey_data_affiliation <- survey_data_affiliation %>%
     mutate(National_Trust = ifelse(National_Trust_noncoded== "Almost never", 1,
                                          ifelse(National_Trust_noncoded== "Only some of the time", 2,
                                                 ifelse(National_Trust_noncoded== "Most of the time", 3,
                                                        ifelse(National_Trust_noncoded== "Just about always", 4, NA)))))


survey_data_affiliation <- survey_data_affiliation %>%
     mutate(LocalGov_Trust = ifelse(LocalGov_trust_noncoded== "Almost never", 1,
                                          ifelse(LocalGov_trust_noncoded== "Only some of the time", 2,
                                                 ifelse(LocalGov_trust_noncoded== "Most of the time", 3,
                                                        ifelse(LocalGov_trust_noncoded== "Just about always", 4, NA)))))


survey_data_affiliation <- survey_data_affiliation %>%
     mutate(Trust_Others = ifelse(Trust_Others_noncoded== "1- You can't be too careful", 1,
                                        ifelse(Trust_Others_noncoded== "2", 2,
                                               ifelse(Trust_Others_noncoded== "3", 3,
                                                     ifelse(Trust_Others_noncoded== "4", 4,
                                                     ifelse(Trust_Others_noncoded== "5- Most people can be trusted", 5, NA))))))
                                              
survey_data_affiliation <- survey_data_affiliation %>%
     mutate(National_Trust_HighLow = ifelse(National_Trust_noncoded== "Almost never", 0,
                                          ifelse(National_Trust_noncoded== "Only some of the time", 0,
                                                 ifelse(National_Trust_noncoded== "Most of the time", 1,
                                                        ifelse(National_Trust_noncoded== "Just about always", 1, NA)))))
                                                        
survey_data_affiliation <- survey_data_affiliation %>%
     mutate(LocalGov_Trust_HighLow = ifelse(LocalGov_trust_noncoded== "Almost never", 0,
                                          ifelse(LocalGov_trust_noncoded== "Only some of the time", 0,
                                                 ifelse(LocalGov_trust_noncoded== "Most of the time", 1,
                                                        ifelse(LocalGov_trust_noncoded== "Just about always", 1, NA)))))

survey_data_affiliation <- survey_data_affiliation %>%
     mutate(Trust_Others_HighLow = ifelse(Trust_Others_noncoded== "1- You can't be too careful", 0,
                                        ifelse(Trust_Others_noncoded== "2", 0,
                                               ifelse(Trust_Others_noncoded== "3", 0,
                                                     ifelse(Trust_Others_noncoded== "4", 1,
                                                     ifelse(Trust_Others_noncoded== "5- Most people can be trusted", 1, NA))))))

survey_data_control_affiliation <- survey_data_affiliation %>%
     filter(Control %in% c("Leave the treaty", "Remain in the treaty")) %>%
     mutate(exit_treaty = ifelse(Control == "Leave the treaty", 1, 0))


model_control_affiliation <- glm(exit_treaty ~ Gender + Political_Party + Religious_Affiliation + National_Trust + LocalGov_Trust + Trust_Others, 
                      data = survey_data_control_affiliation, family = binomial(link = "logit"))


summary(model_control_affiliation)


marginal_effects_control_affiliation <- margins(model_control_affiliation)


summary(marginal_effects_control_affiliation)


survey_data_norms_affiliation <- survey_data_affiliation %>%
     filter(Treatment_Norms %in% c("Leave the treaty", "Remain in the treaty")) %>%
     mutate(exit_treaty = ifelse(Treatment_Norms == "Leave the treaty", 1, 0))


model_norms_affiliation <- glm(exit_treaty ~ Gender + Political_Party + Religious_Affiliation + National_Trust + LocalGov_Trust + Trust_Others, 
                    data = survey_data_norms_affiliation, family = binomial(link = "logit"))


summary(model_norms_affiliation)


marginal_effects_norms_affiliation <- margins(model_norms_affiliation)


summary(marginal_effects_norms_affiliation)


survey_data_consequence_affiliation <- survey_data_affiliation %>%
     filter(Treatment_Consequence %in% c("Leave the treaty", "Remain in the treaty")) %>%
     mutate(exit_treaty = ifelse(Treatment_Consequence == "Leave the treaty", 1, 0))


model_consequence_affiliation <- glm(exit_treaty ~ Gender + Political_Party + Religious_Affiliation + National_Trust + LocalGov_Trust + Trust_Others, 
                          data = survey_data_consequence_affiliation, family = binomial(link = "logit"))


summary(model_consequence_affiliation)


marginal_effects_consequence_affiliation <- margins(model_consequence_affiliation)


summary(marginal_effects_consequence_affiliation)


## FOR BOTH RELIGIOUS ATTENDANCE AND RELIGIOUS AFFILIATION

data_cleaned_both <- `Omnibus_Survey_Analysis` %>% select(Q17, Q23, Q14, Q62...27, Q31, Q33, Q92...182, Q93...183, Q94, Q98, Q99, Q100, Q37, Q131)


renameddata_both <- data_cleaned_both %>% rename(Political_Party_noncoded = Q17, Liberal_Conservative_noncoded = Q23, Election_Choice_noncoded = Q14, Political_Engagement_noncoded = Q62...27, National_Trust_noncoded = Q92...182, LocalGov_trust_noncoded = Q93...183, Trust_Others_noncoded = Q94, Control = Q98, Treatment_Consequence = Q99, Treatment_Norms = Q100, Gender_noncoded = Q31, Racial_Identity_noncoded = Q33, Religious_Affiliation_noncoded  = Q131, Religious_Attendance_noncoded = Q37)


filtered_data_both <- renameddata_both %>% filter(Gender_noncoded %in% c("Female", "Male", "Prefer not to disclose.", "None of the above. I identify myself as"), Political_Party_noncoded %in% c("Republican", "Democrat", "Independent", "Other", "Don't know"), Racial_Identity_noncoded %in% c("White", "Hispanic", "Black", "Multi-racial", "Native American", "Asian", "Other"), Liberal_Conservative_noncoded %in% c("Extremely Liberal", "Liberal", "Slightly Liberal", "Moderate/ Middle of the Road", "Slightly Conservative", "Conservative", "Extremely Conservative"), Religious_Affiliation_noncoded %in% c("None", "Catholic", "Protestant", "Other", "Jewish", "Muslim"), Religious_Attendance_noncoded %in% c("Never", "Once a year or less", "A few times a year", "Once or twice a month", "Once a week", "More than once a week"))


survey_data_both <- filtered_data_both %>%
     mutate(Religious_Affiliation = ifelse(Religious_Affiliation_noncoded== "None", 0,
                                                ifelse(Religious_Affiliation_noncoded== "Catholic", 1,
                                                       ifelse(Religious_Affiliation_noncoded== "Protestant", 1,
                                                              ifelse(Religious_Affiliation_noncoded== "Jewish", 1,
                                                                     ifelse(Religious_Affiliation_noncoded== "Muslim", 1,
                                                                            ifelse(Religious_Affiliation_noncoded== "Other", 1, NA))))) ))


survey_data_both <- survey_data_both %>%
  mutate(Religious_Attendance = ifelse(Religious_Attendance_noncoded== "Never", 1,
                                            ifelse(Religious_Attendance_noncoded== "Once a year or less", 2,
                                                   ifelse(Religious_Attendance_noncoded== "A Few times a year", 3,
                                                          ifelse(Religious_Attendance_noncoded== "Once or twice a month",4,
                                                                 ifelse(Religious_Attendance_noncoded== "Once a week", 5,
                                                                        ifelse(Religious_Attendance_noncoded== "More than once a week", 6, NA))))) ))


survey_data_both <- survey_data_both %>% mutate(Political_Party = ifelse(Political_Party_noncoded== "Democrat", 1, ifelse(Political_Party_noncoded== "Independent", 2, ifelse(Political_Party_noncoded== "Other", 2, ifelse(Political_Party_noncoded== "Don't Know", 2, ifelse(Political_Party_noncoded== "Republican", 3, NA))))))


survey_data_both <- survey_data_both %>% mutate(National_Trust = ifelse(National_Trust_noncoded== "Almost never", 1, ifelse(National_Trust_noncoded== "Only some of the time", 2, ifelse(National_Trust_noncoded== "Most of the time", 3, ifelse(National_Trust_noncoded== "Just about always", 4, NA)))))


survey_data_both <- survey_data_both %>% mutate(LocalGov_Trust = ifelse(LocalGov_trust_noncoded== "Almost never", 1, ifelse(LocalGov_trust_noncoded== "Only some of the time", 2, ifelse(LocalGov_trust_noncoded== "Most of the time", 3, ifelse(LocalGov_trust_noncoded== "Just about always", 4, NA)))))

survey_data_both <- survey_data_both %>% mutate(Trust_Others = ifelse(Trust_Others_noncoded== "1- You can't be too careful", 1, ifelse(Trust_Others_noncoded== "2", 2, ifelse(Trust_Others_noncoded== "3", 3, ifelse(Trust_Others_noncoded== "4", 4, ifelse(Trust_Others_noncoded== "5- Most people can be trusted", 5, NA))))))

survey_data_both <- survey_data_both %>% mutate(National_Trust_HighLow = ifelse(National_Trust_noncoded== "Almost never", 0, ifelse(National_Trust_noncoded== "Only some of the time", 0, ifelse(National_Trust_noncoded== "Most of the time", 1, ifelse(National_Trust_noncoded== "Just about always", 1, NA)))))

survey_data_both <- survey_data_both %>% mutate(LocalGov_Trust_HighLow = ifelse(LocalGov_trust_noncoded== "Almost never", 0, ifelse(LocalGov_trust_noncoded== "Only some of the time", 0, ifelse(LocalGov_trust_noncoded== "Most of the time", 1, ifelse(LocalGov_trust_noncoded== "Just about always", 1, NA)))))

survey_data_both <- survey_data_both %>% mutate(Trust_Others_HighLow = ifelse(Trust_Others== "1- You can't be too careful", 0, ifelse(Trust_Others_noncoded== "2", 0, ifelse(Trust_Others_noncoded== "3", 0, ifelse(Trust_Others_noncoded== "4", 1, ifelse(Trust_Others_noncoded== "5- Most people can be trusted", 1, NA))))))

survey_data_both <- survey_data_both %>%
  mutate(Religious_HighLow = ifelse(Religious_Attendance_noncoded== "Never", 0,
                                            ifelse(Religious_Attendance_noncoded== "Once a year or less", 0,
                                                   ifelse(Religious_Attendance_noncoded== "A Few times a year", 0,
                                                          ifelse(Religious_Attendance_noncoded== "Once or twice a month",0,
                                                                 ifelse(Religious_Attendance_noncoded== "Once a week", 1,
                                                                        ifelse(Religious_Attendance_noncoded== "More than once a week", 1, NA)))))))


survey_data_both <- survey_data_both %>% mutate(Gender = ifelse(Gender_noncoded == "Male", 1, ifelse(Gender_noncoded == "Female", 2, NA)))


survey_data_control_both <- survey_data_both %>% filter(Control %in% c("Leave the treaty", "Remain in the treaty")) %>% mutate(exit_treaty = ifelse(Control == "Leave the treaty", 1, 0))


model_control_both <- glm(exit_treaty ~ Gender + Political_Party + Religious_Affiliation + National_Trust + LocalGov_Trust + Trust_Others + Religious_Attendance, data = survey_data_control_both, family = binomial(link = "logit"))


summary(model_control_both)


marginal_effects_control_both <- margins(model_control_both)


summary(marginal_effects_control_both)


survey_data_norms_both <- survey_data_both %>% filter(Treatment_Norms %in% c("Leave the treaty", "Remain in the treaty")) %>% mutate(exit_treaty = ifelse(Treatment_Norms == "Leave the treaty", 1, 0))


model_norms_both <- glm(exit_treaty ~ Gender + Political_Party + Religious_Affiliation + National_Trust + LocalGov_Trust + Trust_Others + Religious_Attendance, data = survey_data_norms_both, family = binomial(link = "logit"))


summary(model_norms_both)


marginal_effects_norms_both <- margins(model_norms_both)


summary(marginal_effects_norms_both)


survey_data_consequence_both <- survey_data_both %>%
 filter(Treatment_Consequence %in% c("Leave the treaty", "Remain in the treaty")) %>% mutate(exit_treaty = ifelse(Treatment_Consequence == "Leave the treaty", 1, 0))


model_consequence_both <- glm(exit_treaty ~ Gender + Political_Party + Religious_Affiliation + National_Trust + LocalGov_Trust + Trust_Others + Religious_Attendance, data = survey_data_consequence_both, family = binomial(link = "logit"))


summary(model_consequence_both)


marginal_effects_consequence_both <- margins(model_consequence_both)


summary(marginal_effects_consequence_both)



## Marginal effects- consequence

marginal_effects_consequence_attendance_table <- tidy(marginal_effects_attendance_consequence)
write.csv(marginal_effects_consequence_attendance_table, "marginal_effects_consequence_attendance_table.csv") 

marginal_effects_consequence_both_table <- tidy(marginal_effects_consequence_both)
write.csv(marginal_effects_consequence_both_table, "marginal_effects_consequence_both_table.csv")

marginal_effects_consequence_affiliation_table <- tidy(marginal_effects_consequence_affiliation)
write.csv(marginal_effects_consequence_affiliation_table, "marginal_effects_consequence_affiliation_table.csv")

## Marginal effects- norms

marginal_effects_norms_attendance_table <- tidy(marginal_effects_attendance_norms)
write.csv(marginal_effects_norms_attendance_table, "marginal_effects_norms_attendance_table.csv") 

marginal_effects_norms_both_table <- tidy(marginal_effects_norms_both)
write.csv(marginal_effects_norms_both_table, "marginal_effects_norms_both_table.csv")

marginal_effects_norms_affiliation_table <- tidy(marginal_effects_norms_affiliation)
write.csv(marginal_effects_norms_affiliation_table, "marginal_effects_norms_affiliation_table.csv")

## Marginal effects- control

marginal_effects_control_attendance_table <- tidy(marginal_effects_attendance_control)
write.csv(marginal_effects_control_attendance_table, "marginal_effects_control_attendance_table.csv") 

marginal_effects_control_both_table <- tidy(marginal_effects_control_both)
write.csv(marginal_effects_control_both_table, "marginal_effects_control_both_table.csv")

marginal_effects_control_affiliation_table <- tidy(marginal_effects_control_affiliation)
write.csv(marginal_effects_control_affiliation_table, "marginal_effects_control_affiliation_table.csv")


# Load necessary library
library(ggplot2)

# Plot Marginal Effects - Religious Attendance
marginal_effects_control_attendance_table$size_factor <- ifelse(
    marginal_effects_control_attendance_table$p.value < 0.05, 3, 1.5
)

ggplot(marginal_effects_control_attendance_table, aes(x = term, y = estimate)) + 
    geom_point(aes(size = size_factor), alpha = 0.7, color = "blue") + 
    geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), 
                  width = 0.2, color = "blue") + 
    labs(
        title = "Marginal Effects of Control/Religious Attendance on Treaty Exit", 
        x = "Predictor", 
        y = "Estimated Marginal Effect"
    ) + 
    scale_size_continuous(range = c(1.5, 3), guide = "none") + 
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

marginal_effects_norms_attendance_table$size_factor <- ifelse(
    marginal_effects_norms_attendance_table$p.value < 0.05, 3, 1.5
)

ggplot(marginal_effects_norms_attendance_table, aes(x = term, y = estimate)) + 
    geom_point(aes(size = size_factor), alpha = 0.7, color = "blue") + 
    geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), 
                  width = 0.2, color = "blue") + 
    labs(
        title = "Marginal Effects of Norms/Religious Attendance on Treaty Exit", 
        x = "Predictor", 
        y = "Estimated Marginal Effect"
    ) + 
    scale_size_continuous(range = c(1.5, 3), guide = "none") + 
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

marginal_effects_consequence_attendance_table$size_factor <- ifelse(
    marginal_effects_consequence_attendance_table$p.value < 0.05, 3, 1.5 
)

ggplot(marginal_effects_consequence_attendance_table, aes(x = term, y = estimate)) + 
    geom_point(aes(size = size_factor), alpha = 0.7, color = "blue") + 
    geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), 
                  width = 0.2, color = "blue") + 
    labs(
        title = "Marginal Effects of Treatment Consequence/Religious Attendance on Treaty Exit", 
        x = "Predictor", 
        y = "Estimated Marginal Effect"
    ) + 
    scale_size_continuous(range = c(1.5, 3), guide = "none") + 
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Plot Marginal Effects - Religious Affiliation
marginal_effects_control_affiliation_table$size_factor <- ifelse(
    marginal_effects_control_affiliation_table$p.value < 0.05, 3, 1.5
)

ggplot(marginal_effects_control_affiliation_table, aes(x = term, y = estimate)) + 
    geom_point(aes(size = size_factor), alpha = 0.7, color = "blue") + 
    geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), 
                  width = 0.2, color = "blue") + 
    labs(
        title = "Marginal Effects of Control/Religious Affiliation on Treaty Exit", 
        x = "Predictor", 
        y = "Estimated Marginal Effect"
    ) + 
    scale_size_continuous(range = c(1.5, 3), guide = "none") + 
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

marginal_effects_consequence_affiliation_table$size_factor <- ifelse(
    marginal_effects_consequence_affiliation_table$p.value < 0.05, 3, 1.5
)

ggplot(marginal_effects_consequence_affiliation_table, aes(x = term, y = estimate)) + 
    geom_point(aes(size = size_factor), alpha = 0.7, color = "blue") + 
    geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), 
                  width = 0.2, color = "blue") + 
    labs(
        title = "Marginal Effects of Treatment Consequence/Religious Affiliation on Treaty Exit", 
        x = "Predictor", 
        y = "Estimated Marginal Effect"
    ) + 
    scale_size_continuous(range = c(1.5, 3), guide = "none") + 
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

marginal_effects_norms_affiliation_table$size_factor <- ifelse(
 marginal_effects_norms_affiliation_table$p.value < 0.05, 3, 1.5)

ggplot(marginal_effects_norms_affiliation_table, aes(x = term, y = estimate)) + 
  geom_point(aes(size = size_factor), alpha = 0.7, color = "blue") + 
   geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), 
                 width = 0.2, color = "blue") + 
  labs(
      title = "Marginal Effects of Treatment Norms/Religious Affiliation on Treaty Exit", 
      x = "Predictor", 
     y = "Estimated Marginal Effect"
  ) + 
  scale_size_continuous(range = c(1.5, 3), guide = "none") + 
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Plot Marginal Effects - Both Religious Variables
marginal_effects_control_both_table$size_factor <- ifelse(
    marginal_effects_control_both_table$p.value < 0.05, 3, 1.5
)

ggplot(marginal_effects_control_both_table, aes(x = term, y = estimate)) + 
    geom_point(aes(size = size_factor), alpha = 0.7, color = "blue") + 
    geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), 
                  width = 0.2, color = "blue") + 
    labs(
        title = "Marginal Effects of Control/Both Religion Variables on Treaty Exit", 
        x = "Predictor", 
        y = "Estimated Marginal Effect"
    ) + 
    scale_size_continuous(range = c(1.5, 3), guide = "none") + 
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))


marginal_effects_consequence_both_table$size_factor <- ifelse(
 marginal_effects_consequence_both_table$p.value < 0.05, 3, 1.5)

 ggplot(marginal_effects_consequence_both_table, aes(x = term, y = estimate)) + 
  geom_point(aes(size = size_factor), alpha = 0.7, color = "blue") + 
   geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), 
                width = 0.2, color = "blue") + 
  labs(
    title = "Marginal Effects of Treatment Consequence/Both Religion Variables on Treaty Exit", 
     x = "Predictor", 
     y = "Estimated Marginal Effect") + 
  scale_size_continuous(range = c(1.5, 3), guide = "none") + 
 theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

marginal_effects_norms_both_table$size_factor <- ifelse(
  marginal_effects_norms_both_table$p.value < 0.05, 3, 1.5)

ggplot(marginal_effects_norms_both_table, aes(x = term, y = estimate)) + 
  geom_point(aes(size = size_factor), alpha = 0.7, color = "blue") + 
 geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), 
               width = 0.2, color = "blue") + 
   labs(
   title = "Marginal Effects of Treatment Norms/Both Religion Variables on Treaty Exit", 
    x = "Predictor", 
    y = "Estimated Marginal Effect") + 
 scale_size_continuous(range = c(1.5, 3), guide = "none") + 
   theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
##Making Interaction Models
interaction_model_attendance_trust_others <- glm(
    exit_treaty ~ Religious_Attendance * Trust_Others, 
    data = survey_data_attendance_control, 
    family = binomial(link = "logit")
)

interaction_model_attendance_national_trust <- glm(
    exit_treaty ~ Religious_Attendance * National_Trust, 
    data = survey_data_attendance_control, 
    family = binomial(link = "logit")
)

interaction_model_attendance_local_trust <- glm(
    exit_treaty ~ Religious_Attendance * LocalGov_Trust, 
    data = survey_data_attendance_control, 
    family = binomial(link = "logit")
)

interaction_model_party_trust_others <- glm(
    exit_treaty ~ Political_Party * Trust_Others, 
    data = survey_data_attendance_control, 
    family = binomial(link = "logit")
)

interaction_model_party_national_trust <- glm(
    exit_treaty ~ Political_Party * National_Trust, 
    data = survey_data_attendance_control, 
    family = binomial(link = "logit")
)

interaction_model_party_local_trust <- glm(
    exit_treaty ~ Political_Party * LocalGov_Trust, 
    data = survey_data_attendance_control, 
    family = binomial(link = "logit")
)


# Interaction Effects
install.packages("ggeffects")
# Load necessary packages
library(ggplot2)
library(ggeffects)

# Define a function to plot interaction effects
plot_interaction <- function(model, predictor, moderator, data) {
    # Generate predicted probabilities
    interaction_effect <- ggpredict(model, terms = c(predictor, moderator))

    # Plot the interaction effect
    ggplot(interaction_effect, aes(x = x, y = predicted, color = group)) +
        geom_line(size = 1) +
        geom_point(size = 2) +
        labs(x = predictor, y = "Predicted Probability of Exit Treaty",
             color = moderator, title = paste("Interaction Effect of", predictor, "and", moderator)) +
        theme_minimal()
}

# Plot interactions for each model
p1 <- plot_interaction(interaction_model_attendance_trust_others, "Religious_Attendance", "Trust_Others", survey_data_attendance_control)
p2 <- plot_interaction(interaction_model_attendance_national_trust, "Religious_Attendance", "National_Trust", survey_data_attendance_control)
p3 <- plot_interaction(interaction_model_attendance_local_trust, "Religious_Attendance", "LocalGov_Trust", survey_data_attendance_control)

p4 <- plot_interaction(interaction_model_party_trust_others, "Political_Party", "Trust_Others", survey_data_attendance_control)
p5 <- plot_interaction(interaction_model_party_national_trust, "Political_Party", "National_Trust", survey_data_attendance_control)
p6 <- plot_interaction(interaction_model_party_local_trust, "Political_Party", "LocalGov_Trust", survey_data_attendance_control)

# Print plots
print(p1)
print(p2)
print(p3)
print(p4)
print(p5)
print(p6)



##Additional regressions: High/Low Trust and High/Low Religion

model_control_HighTrust <- glm(exit_treaty ~ Gender + Political_Party + Religious_Affiliation + National_Trust_HighLow + LocalGov_Trust_HighLow + Trust_Others_HighLow + Religious_Attendance, data = survey_data_control_both, family = binomial(link = "logit"))

summary(model_control_HighTrust)

model_control_HighReligion <- glm(exit_treaty ~ Gender + Political_Party  + National_Trust + LocalGov_Trust + Trust_Others + Religious_HighLow, data = survey_data_control_both, family = binomial(link = "logit"))

summary(model_control_HighReligion)

model_consequence_HighTrust <- glm(exit_treaty ~ Gender + Political_Party + Religious_Affiliation + National_Trust_HighLow + LocalGov_Trust_HighLow + Trust_Others_HighLow + Religious_Attendance, data = survey_data_consequence_both, family = binomial(link = "logit"))

summary(model_consequence_HighTrust)

model_consequence_HighReligion <- glm(exit_treaty ~ Gender + Political_Party  + National_Trust + LocalGov_Trust + Trust_Others + Religious_HighLow, data = survey_data_consequence_both, family = binomial(link = "logit"))

summary(model_consequence_HighReligion)

model_norms_HighTrust <- glm(exit_treaty ~ Gender + Political_Party + Religious_Affiliation + National_Trust_HighLow + LocalGov_Trust_HighLow + Trust_Others_HighLow + Religious_Attendance, data = survey_data_norms_both, family = binomial(link = "logit"))

summary(model_norms_HighTrust)

model_norms_HighReligion <- glm(exit_treaty ~ Gender + Political_Party  + National_Trust + LocalGov_Trust + Trust_Others + Religious_HighLow, data = survey_data_norms_both, family = binomial(link = "logit"))

summary(model_norms_HighReligion)


##Demographics Summary Statistics
demographic_data <- `Omnibus_Survey_Analysis` %>%
  select(Q17, Q31, Q33, Q131)

demographic_data <- demographic_data %>%
  rename(
    Political_Party = Q17,
    Gender = Q31,
    Racial_Identity = Q33,
    Religious_Affiliation = Q131)

does not attend services

name high low

effect size direction of effect in plot caption
